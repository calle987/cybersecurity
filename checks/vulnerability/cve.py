import sys
import json

import nvdlib
import webtech

wt = webtech.WebTech(options={'json': True})

used_tech = wt.start_from_url('https://' + sys.argv[2], timeout=1)
used_tech = used_tech.get('tech')

res = []
for i in used_tech:
    if i.get('version') is not None:
        res.append(i.get('name') + " " + i.get('version'))

cveText = []
cve = []
scores = []
for i in res:
    r = nvdlib.searchCVE(keyword = i)
    for eachCVE in r:
        cve.append(eachCVE.id)
        scores.append(eachCVE.v3score)
        cveText.append("Id: " + eachCVE.id)
        cveText.append("Score: " + str(eachCVE.v3score))
        cveText.append("Severity: " + eachCVE.v3severity)
        cveText.append("")


if len(cve) > 0:
    print(json.dumps({
        "name": "cve",
        "score": round(10 - max(scores), 2),
        "message": "Found " + str(len(cve)) + "CVE's: " + ", ".join(cve),
        "description": "cve",
        "info": cveText
    }))
else:
    print(json.dumps({
        "name": "cve",
        "score": 10,
        "message": "No CVE's found.",
        "description": "cve"
    }))
