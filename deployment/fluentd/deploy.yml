---
- name: Setup Fluentd
  hosts: localhost
  tasks:
    - name: "Install Helm Chart"
      kubernetes.core.helm:
        name: "{{ config.app.name }}-fluentd"
        namespace: "{{ config.fluentd.namespace }}"
        chart_ref: ../../charts/fluentd-argus
        values:
          image: "{{ config.fluentd.image }}"
          tag: "{{ config.fluentd.tag }}"

          env:
            - name: FLUENT_ELASTICSEARCH_HOST
              value: "{{ config.fluentd.elastic.host }}"
            - name: FLUENT_ELASTICSEARCH_PORT
              value: "{{ config.fluentd.elastic.port | string }}"

          config: |
            # This file is automatically generated by Ansible.
            {%if config.fluentd.elastic.enabled == true %}{{ lookup('file', './fluentd-config/elastic.conf') }}{%endif%}
            {%if config.fluentd.custom.enabled == true %}{{ lookup('file', './fluentd-config/custom.conf') }}{%endif%}
